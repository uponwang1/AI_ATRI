<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>å³æ™‚é€æ™‚æ°£è±¡ç›£æ§ v8.1</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: "Microsoft JhengHei";
            margin: 30px;
            background: #fafafa;
        }
        h2 { margin-top: 0; }
        .info-bar {
            display: flex;
            gap: 18px;
            flex-wrap: wrap;
            margin-bottom: 14px;
        }
        .box {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px 16px;
            min-width: 220px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .value {
            font-size: 26px;
            font-weight: 800;
        }
        .label {
            font-size: 14px;
            color: #555;
        }
        .warn {
            background: #fff3cd;
            border: 1px solid #ffe69c;
            color: #664d03;
            padding: 10px 14px;
            border-radius: 10px;
            margin-bottom: 16px;
        }
        canvas {
            width: 100%;
            height: 420px !important;
            background: white;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            padding: 10px;
        }
        .footer {
            margin-top: 14px;
            font-size: 13px;
            color: #666;
        }
    </style>
</head>

<body>

<h2>ğŸŒ å³æ™‚é€æ™‚æ°£è±¡ç›£æ§ï¼ˆCWB8.1ï¼‰</h2>

{% if err_msg %}
<div class="warn">
    âš ï¸ {{ err_msg }}
</div>
{% endif %}

<div class="info-bar">
    <div class="box">
        <div class="label">ç›®å‰æ°£æº«</div>
        <div class="value" id="tempDisplay">--Â°C</div>
    </div>
    <div class="box">
        <div class="label">ç›®å‰ç›¸å°æ¿•åº¦</div>
        <div class="value" id="humDisplay">-- %</div>
    </div>
    <div class="box">
        <div class="label">æœ€æ–°è§€æ¸¬æ™‚é–“</div>
        <div class="value" style="font-size:18px;" id="obsTime">--</div>
    </div>
</div>

<canvas id="weatherChart"></canvas>

{% if last_update_time %}
<div class="footer">
    ğŸ•’ å¾Œç«¯æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š{{ last_update_time }}
</div>
{% endif %}

<script>
    const labels = {{ labels | tojson }};
    const temps  = {{ temps  | tojson }};
    const hums   = {{ hums   | tojson }};

    // ===== æœ€æ–°å€¼é¡¯ç¤º =====
    const lastTemp = temps.length ? temps[temps.length - 1] : null;
    const lastHum  = hums.length  ? hums[hums.length - 1]  : null;
    const lastTime = labels.length ? labels[labels.length - 1] : null;

    document.getElementById("tempDisplay").textContent = (lastTemp ?? "--") + "Â°C";
    document.getElementById("humDisplay").textContent  = (lastHum  ?? "--") + " %";
    document.getElementById("obsTime").textContent     = lastTime ?? "--";

    // ===== æœ€è¿‘ 7 å¤© + è³‡æ–™ä¸­æ–·è‡ªå‹•æ–·ç·š =====
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

    const filteredX = [];
    const tempY = [];
    const humY = [];

    for (let i = 0; i < labels.length; i++) {
        const curDate = new Date(labels[i]);
        if (curDate < sevenDaysAgo) continue;

        if (filteredX.length > 0) {
            const prevDate = new Date(filteredX[filteredX.length - 1]);
            const diffHours = (curDate - prevDate) / (1000 * 60 * 60);
            if (diffHours > 3) {
                filteredX.push(null);
                tempY.push(null);
                humY.push(null);
            }
        }
        filteredX.push(labels[i]);
        tempY.push(temps[i]);
        humY.push(hums[i]);
    }

    // ===== Chart.js =====
    const ctx = document.getElementById('weatherChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: filteredX,
            datasets: [
                {
                    label: 'æ°£æº« (Â°C)',
                    data: tempY,
                    borderColor: 'red',
                    borderWidth: 2,
                    tension: 0.3,
                    yAxisID: 'y1'
                },
                {
                    label: 'ç›¸å°æ¿•åº¦ (%)',
                    data: humY,
                    borderColor: 'blue',
                    borderWidth: 2,
                    tension: 0.3,
                    yAxisID: 'y2'
                }
            ]
        },
        options: {
            spanGaps: false,
            interaction: { mode: 'index', intersect: false },
            stacked: false,
            scales: {
                y1: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: 'æ°£æº« (Â°C)' }
                },
                y2: {
                    type: 'linear',
                    position: 'right',
                    title: { display: true, text: 'æ¿•åº¦ (%)' },
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });
</script>

</body>
</html>



